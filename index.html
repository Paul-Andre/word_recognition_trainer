<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Word Recognition Trainer</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
	<!-- <script src="index.js"></script> -->
  </body>
</html>


<body>
  <div class="display_container">

    <div class="display_content page shown" id="list_editor">
      
      <form name="input_form" id="input_form" onsubmit="return false;">
        <div>
          <label for="word_list">List to flash:</label><br/>
          <textarea type="textarea" name="word_list" id="word_list" autocapitalize="none" required></textarea>
        </div>

        <div>
          <label for="flash_time"> flash time in ms: </label>
          <input name="flash_time" id="flash_time" type="number" value="50">
        </div>

<fieldset>
    <legend>Mode:</legend>

    <div>
      <input type="radio" id="line_as_one" name="phrase_mode" value="line_as_one"
             checked>
      <label for="line_as_one">Flash each line as one</label>
    </div>

    <div>
      <input type="radio" id="word_by_word" name="phrase_mode" value="word_by_word">
      <label for="word_by_word">Flash each line word by word</label>
    </div>

    <div>
      <input type="radio" id="flash_words_individually" name="phrase_mode" value="words_individually">
      <label for="words_individually">Flash each word individually</label>
    </div>
</fieldset>

        <div>

              <input name="flash_in_order" id="flash_in_order" type="checkbox" >
              <label for="flash_in_order">Flash in order</label>
        </div>

        <button onclick="process()" type="button">Flash</button>

      </form>
    </div>

    <div class="display_content" id="flasher">

      <div class="display_container" >

        <div class="display_content shown" id="flasher_focus">
          <div class="central_box">
            <div class="focus_here_text">
            Focus here and press enter
            </div>
          </div>
        </div>

        <div class="display_content" id="flasher_flash">
          <div class="central_box">
            <div class="flashed_word" id="flasher_flashed_word">
              bread
            </div>
          </div>
        </div>

        <div class="display_content" id="flasher_typing">
          <div class="central_box">
            <div class="flashed_word" contenteditable="true"
                   type="text" id="flasher_typing_input"
                   name="flasher_typing_input"

autocorrect="off" autocapitalize="none" autocomplete="off" spellcheck="false"

                   >

            </div>
          </div>
        </div>

        <div class="display_content" id="flasher_right">
          <div class="central_box">
            <div class="flashed_word" id="flasher_right_word">
              Google
            </div>
            <div>
            <span class="correct_box">
              CORRECT
            </span>
            </div>
            <div style="text-align: middle">
            <br>
              Press enter to continue
            </div>
          </div>
        </div>

        <div class="display_content" id="flasher_wrong">
          <div class="central_box_diff">
            <p>
            <p>
          Was flashed: <span id="flashed_span"> Google </span>
            </p>
          You typed: <span id="you_typed_span"> GGGGGG </span>
            </p>

            <div style="text-align: middle">
              Press enter to continue
            </div>
          </div>
        </div>

      </div>

    </div>

    <div class="display_content page" id="result">
      Hooray you are done.
      <br>
      <button onclick="switch_to('list_editor')"> return to list editor </button>
      <br>
      <br>
      Successful words:
      <div class="displayed_list" id="result_successful_words"> words, words, words </div>
      <br>
      Missed words:
      <div class="displayed_list" id="result_missed_words"> words, words, words </div>
      <br>

    </div>
  </div>

    <script>

      function switch_to(id) {
        let to;
        if ((typeof id) == "string") {
          to = document.getElementById(id); 
        } else {
          to = id;
        }
        let parent = to.parentElement;
        for (let child of parent.children) {
          //let child = parent.children[i];
          child.classList.remove("shown")
        }
        to.classList.add("shown");
      }

      function is_shown(id) {
        let to;
        if ((typeof id) == "string") {
          to = document.getElementById(id); 
        } else {
          to = id;
        }
        return to.classList.contains("shown");
      }

      /* Randomize array in-place using Durstenfeld shuffle algorithm */
      /* https://stackoverflow.com/a/12646864/2356347 */
      function shuffleArray(array) {
        for (var i = array.length - 1; i > 0; i--) {
          var j = Math.floor(Math.random() * (i + 1));
          var temp = array[i];
          array[i] = array[j];
          array[j] = temp;
        }
      }

      function get_form_data() {
        let form = document.getElementById("input_form");
        let formData = new FormData(form);

        let a = {}
        for (const [key, value] of formData) {
          a[key] = value;
        }
        a.flash_in_order = !!(a.flash_in_order);
        //a.split_phrases = !!(a.split_phrases);

        return a;
      }

      function save_form_to_storage() {
        a = get_form_data();

        let json = JSON.stringify(a)
        localStorage.setItem("input_form", json);
      }

      function load_data_from_storage() {

        // Load edited form from localstorage
        let saved_form = localStorage.getItem("input_form");
        if (saved_form) {
          saved_form = JSON.parse(saved_form);
          for (let name in saved_form) {
            console.log(name);
            let value = saved_form[name];
            console.log(value);
            // check if there's a better way

            let form = document.forms["input_form"];
            let element = form.elements[name];
            if (element.type == "checkbox") {
              element.checked = value;

            } else {
              element.value = value;
            }

          }
        }
      }

      document.querySelector("#flasher_typing .central_box")
        .addEventListener("click", function() {
            document.getElementById("flasher_typing_input").focus();
        }, true);


      window.onbeforeunload = save_form_to_storage;
      load_data_from_storage();

      function process() {
        let form = document.getElementById("input_form");

        a = get_form_data();
        console.log(a)

        recognition_list = a.word_list.split('\n') 
        .map(
          (p) => p.trim()
        )
        .filter(
          (p) => p!=""
          )
        ;

        if (a.phrase_mode == "words_individually") {

          recognition_list = recognition_list
            .map(
              (p) => {
                  return p.split(" ").filter((w) => w!="");
              })
          .flat(1)
          .map(
            (w) => [w]
            )
          ;

        } else {

          recognition_list = recognition_list
            .map(
              (p) => {
                if (a.phrase_mode == "word_by_word") {
                  return p.split(" ").filter((w) => w!="");
                }else {
                  return [p]
                }
              })

        }



        if (!a.flash_in_order) {
          shuffleArray(recognition_list);
        }

        console.log(recognition_list);

        recognition_i = 0;
        flash_timeout = a.flash_time;
        successful_phrases = []
        missed_phrases = []

        switch_to("flasher");
        switch_to("flasher_focus");

      }

      let flash_timeout = 30;
      let phrase_flashed = ["asdf"];

      let recognition_list = [];
      let recognition_i = 0;

      let successful_phrases = []
      let missed_phrases = []


      function flash_phrase(word_array, is_entry=true) {
        console.assert(is_shown("flasher"))

        if (is_entry) {
          phrase_flashed = word_array;
        }

        let [first, ...rest] = word_array;

        document.getElementById("flasher_flashed_word").innerText = first;

        switch_to("flasher_flash");

        setTimeout(function() {
          if (rest.length > 0) {
            flash_phrase(rest, false);
          } else {
            document.getElementById("flasher_typing_input").innerText = "";
            switch_to("flasher_typing");
            document.getElementById("flasher_typing_input").focus();
          }

        }, flash_timeout);

      }

      function flash_next() {
        if (recognition_i < recognition_list.length) {
          let words_to_flash = recognition_list[recognition_i];
          recognition_i++;
          flash_phrase (words_to_flash);
        } else {
          document.getElementById("result_successful_words").innerText = 
            successful_phrases.map((a) => a.join(" ")).join("\n");

          document.getElementById("result_missed_words").innerText = 
            missed_phrases.map((a) => a.join(" ")).join("\n");

          switch_to("result")

        }
      }


      function ontouch(evt) {

        if (is_shown("flasher")) {
          console.log(evt);
          if ( is_shown("flasher_focus")) {
              flash_next();
          }
          else if (is_shown("flasher_typing")) {
            document.getElementById("flasher_typing_input").focus();

            setTimeout(function() {
            document.getElementById("flasher_typing_input").focus();
            }, 1000);
          }
          else if (is_shown("flasher_right") ) {
              flash_next()
          }
          else if (is_shown("flasher_wrong")) {
            switch_to("flasher_focus");
          }
        } else if ( is_shown("result")) {
          // switch_to("list_editor");
        }
      }

      window.onfocus = function (evt) {
        if (is_shown("flasher")) {
          console.log(evt);
          if ( is_shown("flasher_focus")) {
          }
          else if (is_shown("flasher_typing")) {
            setTimeout(function() {
            document.getElementById("flasher_typing_input").focus();
            }, 1000);
          }
          else if (is_shown("flasher_right") ) {
          }
          else if (is_shown("flasher_wrong")) {
          }
        }
      }

      //window.addEventListener("click", ontouch, true);
      window.addEventListener("touchstart", ontouch, true);

      document.onkeydown = function(evt) {
        console.log(evt);
        if (is_shown("flasher")) {

          if ( is_shown("flasher_focus")) {

            if (evt.key=="Enter") {

              flash_next();

            }
          }


          else if (is_shown("flasher_typing")) {
            if (evt.key=="Enter") {
              evt.preventDefault();

              console.log(document.getElementById("flasher_typing_input"))
              var typed_word = document.getElementById("flasher_typing_input").innerText;

              var flashed_word = phrase_flashed.join(" ")


              if (typed_word == flashed_word) {
                successful_phrases.push(phrase_flashed);


                document.getElementById("flasher_right_word").innerText = flashed_word;
                switch_to("flasher_right")

              } else {
                missed_phrases.push(phrase_flashed);

                document.getElementById("you_typed_span").innerText = typed_word;
                document.getElementById("flashed_span").innerText = flashed_word;
                switch_to("flasher_wrong")


              }
              
            }
          }

          else if (is_shown("flasher_right") ) {
            if (evt.key=="Enter") {
              flash_next()
            }
          }
          else if (is_shown("flasher_wrong")) {
            if (evt.key=="Enter") {
            switch_to("flasher_focus");
            }
          }

        } else if ( is_shown("result")) {

        }
      }


    </script>

</body>

